#!/bin/bash

# distrib=$(lsb_release -i | cut -d : -f 2)
distrib=""

serverUrl="http://www-info.iutv.univ-paris13.fr/~gauthier/"
serverPOST="$serverUrl/eval.php" # url ou envoyer la requete
# serverPOST="http://192.168.1.24/server/eval.php"
source="marioTestJson" # le dossier ou chercher les fichiers

packages="zenity curl ssh jq yad"
projectName="example_TP1.mar"
requestName="exempleTP1_requetes.json"
idSsh="id_rsa_marionnet"
# scripts="marionnet_getVar marionnet_list marionnet_ssh"
file="$projectName $requestName $idSsh"
timing=600 # temps en seconde

name=""
firstName=""
idExam=""
choice=""

declare -A dataRequest
declare data
declare cable

nbCable=0
nbLine=0

function helpFunc() {
    echo "Usage : $0 [option]

Option :
    --help ................ show help
    --debug ............... debug mode
    --graph ............... graph mode"
    exit 0
}

debug=0
graph=0
exam=$([ $0 == './examMario' ] && echo 1 || echo 0)
TMPDIR=$([ "A$TMPDIR" = "A" ] && echo /tmp || echo $TMPDIR)

if [ $# -ge 1 ]; then
    for i in $(seq 1 $#); do
        if [ "$1" == "--debug" ]; then debug=1
        elif [ "$1" == "--graph" ]; then graph=1
        elif [ "$1" == "--help" ]; then helpFunc
        else
            echo -e "\e[31mERROR :\e[0m Unknown parameter" > /dev/stderr
            exit 1
        fi
        shift
    done
fi

# marioSsh <machine> <cmd>
function marioSsh() {
    local cde=$0
    local PRIVATE_RSA_KEY=id_rsa_marionnet

    # we need more checks
    #-- Checks
    if [ "A$2" = "A" ]; then
        echo "Usage: $cde  host cmd"
        echo "where host is the name of a virtual machine in marionnet"
        exit 1
    fi

    local Host="$1"
    shift
    Cmd="$*"

    resu=`ps aw |grep marionnet|grep "hostname=$Host "|head -1|sed -e 's/^.* eth42=\([^ ]*\) .*$/\1/'`'/'
    if [ "$resu" = "/" ] ; then
        echo "\e[31mERROR :\e[0m machine $Host not found in current marionnet project" > /dev/stderr
        exit 1
    fi

    local tap=`echo $resu | cut -d ',' -f 2`

    if [ "A$tap" = "A" ]; then
        echo "\e[31mERROR :\e[0m no tap found" > /dev/stderr
        exit 1
    fi

    local ip=`/sbin/route -n |grep $tap |cut -d ' ' -f 1`

    local pubKey=$(ssh-keyscan -t ecdsa $ip 2> /dev/null)
    local ref=$(cat ~/.ssh/known_hosts | grep $ip | cut -d ' ' -f 3)
    local search=$(echo $pubKey | cut -d ' ' -f 3)

    if [ "$search" != "$ref" ]; then
        echo $pubKey >> ~/.ssh/known_hosts
    fi

    ssh -xq -i $PRIVATE_RSA_KEY root@$ip $Cmd
}

# cidr2mask <cidr>
function cidr2mask() {
   set -- $(( 5 - ($1 / 8) )) 255 255 255 255 $(( (255 << (8 - ($1 % 8))) & 255 )) 0 0 0
   [ $1 -gt 1 ] && shift $1 || shift
   echo ${1-0}.${2-0}.${3-0}.${4-0}
}

# testPresence <machine>
function testPresence() {
    if [ "A$1" != "A" ]; then
        local res=$(ps aw | grep marionnet | grep "$1" | head -1)
        [ "A$res" != "A" ] && echo ok
    fi
}

# getIPAddress <machine> [interface]
function getIPAddress() {
    if [ "A$1" != "A" ]; then
        local eth=$([ "A$2" != "A" ] && echo $2 || echo eth0)
        marioSsh $1 ip addr show $eth | grep 'net ' | awk '{print $2}' | cut -d / -f 1
    fi
}

# getMask <machine> [interface]
function getMask() {
    if [ "A$1" != "A" ]; then
        local eth=$([ "A$2" != "A" ] && echo $2 || echo eth0)
        cidr=$(marioSsh $1 ip addr show $eth | grep 'net ' | awk '{print $2}' | cut -d / -f 2)
        cidr2mask $cidr
    fi
}

# getRoute <machine> <route>
function getRoute() {
    if [ "A$1" != "A" ] && [ "A$2" != "A" ]; then
        local route=$([ "$2" = "default" ] && echo '0.0.0.0' || echo $2)
        marioSsh $1 route -n | grep "^$route"
    fi
}

# getNet <machine> [interface]
function getNet() {
    if [ "A$1" != "A" ]; then
        local eth=$([ "A$2" != "A" ] && echo $2 || echo eth0)
        marioSsh $1 route -n | grep "U[^G] .* $eth$" | awk '{print $1}'
    fi
}

# pingMachine <machine1> <machine2> [interface]
function pingMachine() {
    if [ "A$1" != "A" ] && [ "A$2" != "A" ]; then
        local eth=$([ "A$3" != "A" ] && echo $3 || echo eth0)
        local ip=$(getIPAddress $2 $eth)
        marioSsh $1 ping -c 1 -w 1 $ip &> /dev/null && echo ok
    fi
}

# getCable <machine1> <machine2>
function getCable() {
    if [ "A$1" != "A" ] && [ "A$2" != "A" ]; then
        local cbl=""
        local res=""

        for i in $(seq 1 $nbCable); do
            res=$(echo ${cable[$i]} | grep "$1 $2")
            if [ "A$res" != "A" ]; then
                cbl=$res
            fi
        done

        echo $cbl
    fi
}

# checkIP <machine> [interface]
function checkIP() {
    if [ "A$1" != "A" ]; then
        local eth=$([ "A$2" != "A" ] && echo $2 || echo eth0)
        local mask=$(getMask $1 $eth)
        local ip=$(getIPAddress $1 $eth)
        local net=$(getNet $1 $eth)

        local octMask=$(echo $mask | cut -d . -f 1)
        local octIP=$(echo $ip | cut -d . -f 1)
        local res=$(($octMask & $octIP))

        for i in {2..4}; do
            octMask=$(echo $mask | cut -d . -f $i)
            octIP=$(echo $ip | cut -d . -f $i)
            res="$res.$(($octMask & $octIP))"
        done

        [ "$res" = "$net" ] && echo ok
    fi
}

function installDep() {
    [ $debug -eq 1 ] && echo "Searching for dependance ..."
    for p in $packages; do
        res=$(command -v $p | wc -l)
        if [ $res -eq 1 ]; then
            [ $debug -eq 1 ] && echo "Package $p found"
        else
            echo "Installing $p ..."
            sudo apt install $p
        fi
    done
}

function inputText() {
    while [ "A$firstName" = "A" ]; do
        read -p "Enter your first name : " firstName
    done
    while [ "A$name" = "A" ]; do
        read -p "Enter your name : " name
    done
    while [ "A$idExam" = "A" ]; do
        read -p "Enter your exam id : " idExam
    done
}

function inputGraph() {
    local output=$(zenity --forms --title "input" \
    --text "Enter your informations" \
    --add-entry "Enter your first name" \
    --add-entry "Enter your name" \
    --add-entry "Enter your exam id")

    if echo $output | grep -E ".+\|.+\|.+" &> /dev/null; then
        firstName=$(echo $output | cut -d '|' -f 1)
        name=$(echo $output | cut -d '|' -f 2)
        idExam=$(echo $output | cut -d '|' -f 3)
    else
        inputGraph
    fi
}

function verification() {
    local res=$(ps aux | grep marionnet | grep daemon.native | wc -l)
    if [ $res -eq 1 ]; then
        [ $debug -eq 1 ] && echo "Marionnet daemon is already running"
    else
        sudo /etc/init.d/marionnet-daemon start
        echo "Marionnet daemon started"
    fi

    res=$(ls -ld /tmp/marionnet-*.dir/)
    if [ "A$res" = "A" ]; then
        echo -e "\e[31mERROR :\e[0m No marionnet dir found in $TMPDIR, is it running ?" > /dev/stderr
        exit 1
    fi
    if [ `echo $res | wc -l` -gt 1 ]; then
        echo -e "\e[31mERROR :\e[0m more than one instance of marionnet detected, may be
        something wrong happened to some of them ?" > /dev/stderr
        exit 1
    fi

}

function lauchMarionnet() {
    if [ -f $projectName ]; then
        res=$(ps aux | grep marionnet | grep $projectName | wc -l)
        if [ $res -eq 0 ]; then 
            marionnet $projectName 2> /dev/null &
            echo "Marionnet started"
        else
            [ $debug -eq 1 ] && echo "Marionnet already running"
        fi
    else
        echo "Marionnet project does not exist"
        exit 1
    fi
}

function getMarionetFile() {
    for f in $file; do
        if [ ! -f $f ]; then
            echo "Downloading $f ..."
            curl -s $serverUrl/$source/$f -o $f
        else
            [ $debug -eq 1 ] && echo "$f already exist"
        fi
    done

    if [ -f $idSsh ]; then
        res=$(ls -l $idSsh | cut -d ' ' -f 1)
        if [ $res != "-rw-------" ]; then
            [ $debug -eq 1 ] && echo "Change chmod to 600"
            chmod 600 $idSsh
        fi
    fi
}

function parseRequest() {
    [ $debug -eq 1 ] && echo "Parsing request ..."
    nbLine=$(grep label $requestName | wc -l)
    local l=0

    for i in $(seq 0 $((nbLine - 1))); do
        l=$((i+1))
        dataRequest[$l,1]=$(jq -r ".[$i].label" < $requestName)
        dataRequest[$l,2]=$(jq -r ".[$i].command" < $requestName)
    done

    echo "$nbLine request found"
}

function parseCable() {
    local pName=$(echo $projectName | cut -d . -f 1)
    local patternD='DIRECT CABLE EDGES'
    local patternC='CROSSOVER/SERIAL CABLE EDGES'
    local char=""
    local i=0
    
    [ $debug -eq 1 ] && echo "Parsing cable ..."

    while read line ; do
        if [ "$(echo $line)" == "$patternD" ]; then
            char='direct'
        elif [ "$(echo $line)" == "$patternC" ]; then
            char='cross'
        fi

        line=$(echo $line | grep '^[^:]*:img:c -> [^:]*:img:c')
        if [ "A$line" != "A" ]; then
            i=$((i + 1))
            cable[$i]=$(echo $line | sed -e "s/^\([^:]*\):img:c -> \([^:]*\):img:c .*\">\([^<]*\).*$/$char \3 \1 \2/")
            i=$((i + 1))
            cable[$i]=$(echo $line | sed -e "s/^\([^:]*\):img:c -> \([^:]*\):img:c .*\">\([^<]*\).*$/$char \3 \2 \1/")
        fi
    done < $TMPDIR/marionnet-*.dir/$pName/tmp/sketch.dot

    nbCable=$i
}

function formatJson() {
    send="{\"data\":["
    for i in $(seq 1 $(( nbLine-1 ))); do
        send="$send\"${data[$i]}\","
    done
    send="$send\"${data[$nbLine]}\"], \"source\":\"$source\", \"examMode\":\"$exam\""

    if [ $exam -eq 1 ]; then
        send="$send, \"firstName\":\"$firstName\", \"name\":\"$name\", \"idExam\":\"$idExam\"}"
    else
        send="$send}"
    fi
}

function getData() {
    local show=""
    for i in $(seq 1 $nbLine); do
        show="Getting data $i/$nbLine : ${dataRequest[$i,1]} ..."
        [ $debug -eq 0 ] && echo -en "$show \r" || echo $show

        data[$i]=$(${dataRequest[$i,2]}) # execute la commande

        # echo ${dataRequest[$i,1]}
        # echo ${dataRequest[$i,2]}
        # echo ${data[$i]}
    done
    echo "======================Result======================"
}

function evaluation() {
    echo "Evaluation in progress ..."

    parseRequest
    parseCable
    getData
    formatJson

    if [ $graph -eq 1 ]; then
        curl -H "Content-Type: application/json" -X POST -d "$send" $serverPOST | zenity --text-info
    else
        curl -H "Content-Type: application/json" -X POST -d "$send" $serverPOST
    fi
}

function normalModeText() {
    lauchMarionnet

    while [ "$choice" != "n" ]; do
        choice=""
        while [ "A$choice" = "A" ] || [ "$choice" != "y" ] && [ "$choice" != "n" ]; do
            read -p "Would you like to be evaluated (y/n) : " choice
        done
        if [ "$choice" = "y" ]; then
            res=$(ps aux | grep marionnet | grep $projectName | wc -l)
            if [ $res -eq 1 ]; then 
                evaluation
            else 
                echo "Marionnet not launch"
                exit 1
            fi
        else
            echo "Good bye"
        fi
    done
}

function normalModeGraph() {
    lauchMarionnet

    if zenity --question --text "Would you like to be evaluated"; then
        res=$(ps aux | grep marionnet | grep $projectName | wc -l)
        if [ $res -eq 1 ]; then 
            evaluation
        else 
            echo "Marionnet not launch"
            exit 1
        fi
    else
        echo "Good bye"
    fi
}

function timerGraph() {
    #local percent=0
    for sec in $(seq 0 $timing); do
        echo "# $((timing - sec)) second"
        # percent=$((100 * sec / timing))
        echo $((100 * sec / timing))
        sleep 1
    done | zenity --progress --percentage=0
}

function timerText() {
    for sec in $(seq 0 $timing); do
        echo -en "$((timing - sec)) second left ...\r"
        sleep 1
    done
}

function examMode() {
    [ $graph -eq 1 ] && inputGraph || inputText
    lauchMarionnet

    echo "Your are in exam mode, you have $timing seconds ..."
    [ $graph -eq 1 ] && timerGraph || timerText

    evaluation
}

installDep
verification
getMarionetFile
if [ $exam -eq 1 ]; then
    examMode
else
    [ $graph -eq 1 ] && normalModeGraph || normalModeText
fi