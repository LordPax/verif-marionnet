#!/bin/bash

# distrib=$(lsb_release -i | cut -d : -f 2)
distrib=""

serverUrl="http://www-info.iutv.univ-paris13.fr/~gauthier/"
serverPOST=$serverUrl
# serverPOST="http://192.168.1.24/server/"

packages="zenity wget ssh sshpass"
projectName="example_TP1.mar"
requestName="exempleTP1_requetes.txt"
urlSsh="id_rsa_marionnet"
scripts="marionnet_getVar marionnet_list marionnet_ssh"

name=""
firstName=""
idExam=""
choice=""

declare -A dataRequest

function installDep() {
    echo "Searching for dependance ..."
    for p in $packages; do
        res=$(command -v $p | wc -l)
        if [[ $res -eq 1 ]]; then
            echo "Package $p found"
        else
            echo "Installing $p ..."
            sudo apt install $p
        fi
    done
}

function downloadScript() {
    if [[ ! -d script ]]; then
        mkdir script
        echo "script/ created"
    fi

    for sc in $scripts; do
        if [[ ! -f script/$sc ]]; then
            echo "Downloading $sc ..."
            cd script
            wget -nv $serverUrl/$sc
            chmod +x $sc
            cd ..
        else
            echo "$sc already exist"
        fi
    done
}

function input() {
    while [[ "A$firstName" = "A" ]]; do
        read -p "Enter your first name : " firstName
    done
    while [[ "A$name" = "A" ]]; do
        read -p "Enter your name : " name
    done
    while [[ "A$idExam" = "A" ]]; do
        read -p "Enter your exam id : " idExam
    done
}

function verifDeamon() {
    res=$(ps aux | grep marionnet | grep daemon.native | wc -l)
    if [[ $res -eq 1 ]]; then
        echo "Marionnet daemon is already running"
    else
        sudo /etc/init.d/marionnet-daemon start
        echo "Marionnet daemon started"
    fi
}

function getMarionetFile() {
    if [[ ! -f $projectName ]]; then
        echo "Downloading project file ..."
        wget -nv $serverUrl/$projectName
    fi

    if [[ ! -f $requestName ]]; then
        echo "Downloading request file ..."
        wget -nv $serverUrl/$requestName
    fi
    
    if [[ -f $projectName ]]; then
        res=$(ps aux | grep marionnet | grep $projectName | wc -l)
        if [[ $res -eq 0 ]]; then 
            marionnet $projectName &
            echo "Marionnet started"
        else
            echo "Marionnet already running"
        fi
    else
        echo "Marionnet project does not exist"
        exit 1
    fi
}

function parseRequest() {
    echo "Parsing request ..."
    nbLine=$(cat $requestName | grep '^[^#]' | wc -l)

    for i in $(seq 1 $nbLine); do
        for j in {1..5}; do
            dataRequest[$i,$j]=$(cat $requestName | grep '^[^#]' | sed -n "${i}p" | cut -d ';' -f $j)
        done
    done
    
    # local pName=$(echo $projectName | cut -d . -f 1)
    # cable=$(grep '^[^:]*:img:c -> [^:]*:img:c' /tmp/marionnet-*.dir/$pName/tmp/sketch.dot | sed -e 's/^\([^:]*\):img:c -> \([^:]*\):img:c .*$/\1 - \2/' | tr -d '\n')
    # cable=$(grep '^[^:]*:img:c -> [^:]*:img:c' /tmp/marionnet-*.dir/$pName/tmp/sketch.dot | sed -e 's/^\([^:]*\):img:c -> \([^:]*\):img:c .*">\([^<]*\).*$/\3 \1 \2; /' | tr -d '\n')

    echo "$nbLine request found"
}

function parseCable() {
    local pName=$(echo $projectName | cut -d . -f 1)
    
    local seenD=0
    local seenC=0
    local patternD='DIRECT CABLE EDGES'
    local patternC='CROSSOVER/SERIAL CABLE EDGES'

    cable=$(cat /tmp/marionnet-*.dir/$pName/tmp/sketch.dot | while read ligne ; do
        if [[ $(echo $ligne) == "$patternD" ]]; then
            seenD=1;seenC=0
        elif [[ $(echo $ligne) == "$patternC" ]]; then
            seenD=0;seenC=1
        fi
        
        ligne=$(echo $ligne | grep '^[^:]*:img:c -> [^:]*:img:c')
        if [[ $seenD -eq 1 ]]; then
            echo $ligne | sed -e 's/^\([^:]*\):img:c -> \([^:]*\):img:c .*$/d \1 \2;/' | tr -d '\n'
        elif [[ $seenC -eq 1 ]]; then
            echo $ligne | sed -e 's/^\([^:]*\):img:c -> \([^:]*\):img:c .*$/c \1 \2;/' | tr -d '\n'
        fi
    done)
}

function evaluation() {
    echo "Evaluation in progress ..."
    parseRequest
    parseCable
    
    for i in $(seq 1 $nbLine); do
        # echo "${dataRequest[$i,1]} : $(script/marionnet_ssh ${dataRequest[$i,2]} ${dataRequest[$i,3]} | grep -o ${dataRequest[$i,4]})"
        data[$i]=$(script/marionnet_ssh ${dataRequest[$i,2]} ${dataRequest[$i,3]} | sed -n '4p')
        echo "Getting data $i/$nbLine ..."
    done
    
    sendData
}

function sendData() {
    send="{\"data\":["
    for i in $(seq 1 $(( nbLine-1 ))); do
        send="$send\"${data[$i]}\","
    done
    send="$send\"${data[$nbLine]}\"],\"cable\":\"$cable\"}"
    
    curl -H "Content-Type: application/json" -X POST -d "$send" $serverPOST
}

function examMode() {
    echo "exam mode"
}

function loop() {
    while [[ $choice != "n" ]]; do
        choice=""
        while [[ "A$choice" = "A" ]] || [[ $choice != "y" ]] && [[ $choice != "n" ]]; do
            read -p "Would you like to be evaluated (y/n) : " choice
        done
        if [[ $choice = "y" ]]; then
            evaluation
        else
            echo "Good bye"
        fi
    done
}

installDep
downloadScript
verifDeamon
# input
getMarionetFile
loop
